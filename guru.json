{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Cloudformation template to create a data lake using AWS Glue and S3",
  "Parameters": {
    "Environment": {
      "Description": "Parameter for environment prefix, default value dev",
      "Type": "String",
      "Default": "dev"
    },
    "Source": {
      "Description": "Name of the Data Source",
      "Type": "String",
      "Default": "guru"
    },
    "BucketName": {
      "Description": "Name of the Bucket",
      "Type": "String",
      "Default": "freelance-analytics-codebase"
    },
    "GlueWorkflowRoleParameter": {
      "Description": "Name of Glue Role",
      "Type": "String"
    }
  },
  "Resources": {
    "GuruDataIngest": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Command": {
          "Name": "pythonshell",
          "PythonVersion": "3",
          "ScriptLocation": "s3://${BucketName}/${Environment}/guru_handler.py"
        },
        "DefaultArguments": {
          "--incremental": "True",
          "--workflow_name": "${Environment}-${Source}-workflow",
          "--extra-py-files": "s3://${BucketName}/${Environment}/fa_guru_ingest.py,s3://${BucketName}/${Environment}/s3_utils.py"
        },
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "GlueVersion": "1.0",
        "MaxRetries": 0,
        "Name": "${Environment}-${Source}-jobs-data-ingest",
        "Timeout": 2880
      }
    },
    "GuruDataCurated": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Command": {
          "Name": "glueetl",
          "ScriptLocation": "s3://${BucketName}/${Environment}/fa_guru_transformation.py"
        },
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "GlueVersion": "2.0",
        "WorkerType": "G.1X",
        "NumberOfWorkers": 2,
        "MaxRetries": 0,
        "Name": "${Environment}-${Source}-jobs-data-curated",
        "DefaultArguments": {
          "--job-bookmark-option": "job-bookmark-disable"
        },
        "Timeout": 2880
      }
    },
    "GuruWorkflow": {
      "Type": "AWS::Glue::Workflow",
      "Properties": {
        "Description": "Fetching raw data from the guru.com platform and storing it in an s3 bucket after transformation",
        "Name": "${Environment}-${Source}-workflow"
      }
    },
    "GuruIngestTrigger": {
      "Type": "AWS::Glue::Trigger",
      "Properties": {
        "Description": "To run guru raw data ingestion job",
        "Type": "SCHEDULED",
        "Schedule": "cron(0 12 * * ? *)",
        "WorkflowName": "GuruWorkflow",
        "StartOnCreation": "true",
        "Actions": [
          {
            "JobName": "${Environment}-${Source}-jobs-data-ingest"
          }
        ],
        "Name": "${Environment}-${Source}-jobs-Ingest-trigger"
      }
    },
    "GuruTransformationTrigger": {
      "Type": "AWS::Glue::Trigger",
      "Properties": {
        "Type": "CONDITIONAL",
        "WorkflowName": "GuruWorkflow",
        "StartOnCreation": "true",
        "Actions": [
          {
            "JobName": "${Environment}-${Source}-jobs-data-curated"
          }
        ],
        "Predicate": {
          "Conditions": [
            {
              "LogicalOperator": "EQUALS",
              "JobName": "${Environment}-${Source}-jobs-data-ingest",
              "State": "SUCCEEDED"
            }
          ],
          "Logical": "ANY"
        },
        "Name": "${Environment}-${Source}-jobs-transformation-trigger"
      }
    }
  }
}